################################################################
#  BASIC STARTER CONFIG – SKR Mini E3 V3  + 350×350×100 printer #
#################################################################

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_22001E000350415339373620-if00
baud: 115200
restart_method: command

#################################################################
# Motion and Axis Limits                                        #
#################################################################

[printer]
kinematics: cartesian
max_velocity: 450          # travel speed ceiling (mm/s)
max_accel: 6000            # XY accel
max_accel_to_decel: 6000
square_corner_velocity: 8  # keeps corners snappy without ringing
max_z_velocity: 25
max_z_accel: 300

#################################################################
# Stepper Motors                                                #
#################################################################

[stepper_x]
step_pin: PB13
dir_pin: PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC0
position_endstop: 0
position_max: 300
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin:  PC10
uart_address: 0
run_current: 0.90
stealthchop_threshold: 0

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC1
position_endstop: 0
position_max: 350
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin:  PC10
uart_address: 1
run_current: 0.90
stealthchop_threshold: 0

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 12
endstop_pin: ^!PC2
position_endstop: 0.0
position_max: 18.7
homing_speed: 4
homing_positive_dir: false


[tmc2209 stepper_z]
uart_pin: PC11
tx_pin:  PC10
uart_address: 2
run_current: 0.90
stealthchop_threshold: 0

#[manual_stepper head_rot]
#step_pin: PB3
#dir_pin: PB4          # change to !PB4 if direction is wrong
#enable_pin: !PD1      # flip to PC3 if it never enables
#microsteps: 16
#rotation_distance: 360
#velocity: 10
#accel: 100

[extruder]
step_pin: PB3
dir_pin: PB4            # add ! if backwards
enable_pin: !PD1        # PD1 low = enabled (you proved PD1 is the one)
microsteps: 16
rotation_distance: 360  # 1 unit = 1°
nozzle_diameter: 0.4    # dummy
filament_diameter: 1.75 # dummy
heater_pin: PA1
sensor_type: temperature_mcu
control: watermark
min_temp: 0
max_temp: 999
min_extrude_temp: 0
max_extrude_only_distance: 100000
max_extrude_only_velocity: 200

[tmc2209 extruder]
uart_pin: PC11
tx_pin:  PC10
uart_address: 3
run_current: 0.45       # LOWER THIS! try 0.40–0.55
hold_current: 0.10      # low hold current so it doesn't cook while idle
stealthchop_threshold: 999

#################################################################
# Extruder                                                      #
#################################################################

[extruder]
min_extrude_temp: 0
max_extrude_cross_section: 100000
max_extrude_only_distance: 100000

#[extruder]
#step_pin: PB3
#dir_pin: PB2
#enable_pin: !PC3
#microsteps: 16
#rotation_distance: 34.924
#nozzle_diameter: 0.400
#filament_diameter: 1.750
#heater_pin: PA1
#sensor_type: EPCOS 100K B57560G104F
#sensor_pin: PA0
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#min_temp: 10
#max_temp: 275
#min_extrude_temp: 170

#################################################################
# Bed Heater                                                    #
#################################################################

#[heater_bed]
#heater_pin: PA3
#sensor_type: EPCOS 100K B57560G104F
#sensor_pin: PA2
#control: pid
#pid_Kp: 63.0
#pid_Ki: 2.25
#pid_Kd: 440.0
#min_temp: 0
#max_temp: 130

#################################################################
# Fans                                                          #
#################################################################

[fan]
pin: PA4

#[heater_fan hotend_fan]
#heater: extruder
#pin: PC5

[fan_generic controller_fan]
pin: PA7
max_power: 1.0        # full speed at S255
shutdown_speed: 0     # off when Klipper shuts down

# FAN1 (PC7) -> "flat" / bottom light
[fan_generic light_flat]
pin: PC7
max_power: 1.0
kick_start_time: 0.0
off_below: 0.0
cycle_time: 0.001        # 1 kHz PWM; raise to 0.0005 (2 kHz) if needed

# FAN2 (PB15) -> "Z" / nozzle light
[fan_generic light_z]
pin: PB15
max_power: 1.0
kick_start_time: 0.0
off_below: 0.0
cycle_time: 0.001

[gcode_macro F_ON]
gcode: SET_FAN_SPEED FAN=light_flat SPEED=1.0

[gcode_macro F_OFF]
gcode: SET_FAN_SPEED FAN=light_flat SPEED=0.0

[gcode_macro Z_ON]
gcode: SET_FAN_SPEED FAN=light_z SPEED=1.0

[gcode_macro Z_OFF]
gcode: SET_FAN_SPEED FAN=light_z SPEED=0.0

# Optional: set brightness 0..255 like an LED
[gcode_macro F_SET]
gcode:
  {% set s = params.S|default(255)|int %}
  SET_FAN_SPEED FAN=light_flat SPEED={(s/255.0)}

[gcode_macro Z_SET]
gcode:
  {% set s = params.S|default(255)|int %}
  SET_FAN_SPEED FAN=light_z SPEED={(s/255.0)}

#################################################################
# Display (12864)                                               #
#################################################################

#[display]
#lcd_type: st7920
#cs_pin: PA15
#sclk_pin: PB10
#sid_pin: PB12
#encoder_pins: ^PC6, ^PC7
#click_pin: ^!PB13

[output_pin PUMP]
pin: PC9 # HB MOSFET
pwm: false
value: 0
shutdown_value: 0

[output_pin SOL]
pin: PC8 # E0 MOSFET
pwm: false
value: 0
shutdown_value: 0

[virtual_sdcard]
path: ~/printer_data/gcodes


#################################################################
# G-Code Macros                                                 #
#################################################################

[gcode_macro START_PRINT]
gcode:
    G28
    G90
    M117 Printing…

[gcode_macro END_PRINT]
gcode:
    M104 S0
    M140 S0
    G91
    G1 Z+5 F300
    G90
    M84
[gcode_macro M6]
gcode:
    M117 Tool change ignored


[gcode_macro VAC_ON]
gcode:
  SET_PIN PIN=PUMP VALUE=1
  M400

[gcode_macro VAC_OFF]
gcode:
  SET_PIN PIN=PUMP VALUE=0
  M400

[gcode_macro AIR_ON]
gcode:
  SET_PIN PIN=SOL VALUE=1
  M400

[gcode_macro AIR_OFF]
gcode:
  SET_PIN PIN=SOL VALUE=0
  M400

# Optional: ensure you never blow while vacuum is on
[gcode_macro VAC_PICK]
gcode:
  AIR_OFF
  SET_PIN PIN=PUMP VALUE=1

[gcode_macro VAC_RELEASE]
gcode:
  SET_PIN PIN=PUMP VALUE=0
  G4 P100            ; 100 ms settle
  AIR_ON
  G4 P150            ; short puff
  AIR_OFF

#[gcode_macro CHECK_ENN]
#gcode:
#  DUMP_TMC STEPPER=extruder

[idle_timeout]
timeout: 30
gcode:
  SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0

[gcode_macro OPNP_HOME]
description: Home for OpenPnP and zero coordinates
gcode:
  G28
  G90
  G92 x0 y0 z0 e0
  M114
